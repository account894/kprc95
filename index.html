<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ—ï¸ í’ˆì…ˆë‹¨ê°€ ì§€ëŠ¥í˜• ê³„ì‚°ê¸° (ì´ˆì •ë°€í˜•)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ì—‘ì…€ íŒŒì¼ ì²˜ë¦¬ ë° ìŠ¤íƒ€ì¼ ì ìš©ì„ ìœ„í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ (ìŠ¤íƒ€ì¼ ì§€ì› ë²„ì „) -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap');
        body { font-family: 'Pretendard', sans-serif; }
        
        /* í…Œì´ë¸” ë³¸ë¬¸ì€ 9px ìœ ì§€ */
        .data-table th { 
            @apply bg-slate-100 text-slate-700 font-bold p-1 border border-slate-300 sticky top-0 whitespace-nowrap; 
            font-size: 9px;
        }
        
        .data-table td { 
            @apply p-1 border border-slate-200 text-center whitespace-nowrap overflow-hidden text-ellipsis; 
            font-size: 9px;
            min-height: 22px;
        }
        
        /* ê°€ë¡œ ìŠ¤í¬ë¡¤ë°” ê°•ì œ ìœ ì§€ ë° ë””ìì¸ */
        .scroll-container {
            display: block;
            width: 100%;
            overflow-x: auto; /* ì¢Œìš° ìŠ¤í¬ë¡¤ í™œì„±í™” */
            -webkit-overflow-scrolling: touch;
        }

        .scroll-container::-webkit-scrollbar { height: 10px; display: block !important; }
        .scroll-container::-webkit-scrollbar-track { background: #f8fafc; }
        .scroll-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 5px; border: 2px solid #f8fafc; }
        .scroll-container::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .loading-spinner { border-top-color: #3b82f6; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #toast {
            visibility: hidden;
            min-width: 250px;
            margin-left: -125px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 12px;
            position: fixed;
            z-index: 100;
            left: 50%;
            bottom: 30px;
            font-size: 14px;
        }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    </style>
</head>
<body class="bg-slate-50 min-h-screen p-4">

    <div id="toast">ë©”ì‹œì§€ ë‚´ìš©</div>

    <div class="max-w-full mx-auto bg-white rounded-xl shadow-xl overflow-hidden border border-slate-200">
        <!-- Header: í¬ê¸° í‚¤ì›€ -->
        <div class="bg-slate-800 p-6 text-white">
            <h1 class="text-2xl font-bold flex items-center gap-3">
                <span>ğŸ—ï¸</span> í’ˆì…ˆë‹¨ê°€ ì§€ëŠ¥í˜• ìë™ ì‚°ì¶œ ì‹œìŠ¤í…œ
            </h1>
            <p class="text-slate-400 mt-2 text-sm">
                ì»¨íŠ¸ë¡¤ ì¸í„°í˜ì´ìŠ¤ëŠ” ê¸°ë³¸ í¬ê¸°ë¡œ, ì‚°ì¶œ ë‚´ì—­ì€ ì´ˆì •ë°€ 9px ë·°ë¡œ ì œê³µë©ë‹ˆë‹¤.
            </p>
        </div>

        <div class="p-6">
            <!-- Configuration & Upload: ì¸í„°í˜ì´ìŠ¤ í¬ê¸° í™•ëŒ€ ë° í…ìŠ¤íŠ¸ ê¸°ë³¸ê°’ ì ìš© -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="bg-blue-50 p-5 rounded-lg border border-blue-100 shadow-sm">
                    <button id="syncBtn" onclick="syncSheetData()" class="w-full bg-white border-2 border-blue-600 text-blue-600 hover:bg-blue-50 py-3 rounded-lg text-base font-bold shadow-md flex items-center justify-center gap-2 transition-all active:scale-[0.98]">
                        ğŸ”„ í’ˆì…ˆ DB ë™ê¸°í™”
                    </button>
                    <p id="syncStatus" class="mt-3 text-sm text-slate-600 text-center font-medium">ë°ì´í„° ë¡œë“œ ì „ì…ë‹ˆë‹¤.</p>
                </div>

                <div class="bg-emerald-50 p-5 rounded-lg border border-emerald-100 shadow-sm flex items-center">
                    <input type="file" id="fileInput" accept=".xlsx, .xls" 
                        class="block w-full text-sm text-slate-500 file:mr-4 file:py-2.5 file:px-6 file:rounded-lg file:border-0 file:text-sm file:font-bold file:bg-emerald-600 file:text-white hover:file:bg-emerald-700 cursor-pointer"
                    />
                </div>
            </div>

            <!-- Loading -->
            <div id="loading" class="hidden flex-col items-center justify-center py-12">
                <div class="loading-spinner w-8 h-8 border-4 border-slate-200 rounded-full mb-3"></div>
                <p class="text-slate-500 text-lg font-bold">ë°ì´í„° ë¶„ì„ ë° ì‚°ì¶œ ì¤‘...</p>
            </div>

            <!-- Result Table Area -->
            <div id="resultArea" class="hidden">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-bold text-slate-800">ì‚°ì¶œ ë‚´ì—­ ê²°ê³¼ (í•˜ë‹¨ ìŠ¤í¬ë¡¤ì„ ì´ìš©í•˜ì„¸ìš”)</h2>
                    <button onclick="exportToExcel()" class="bg-emerald-600 text-white px-6 py-2.5 rounded-lg text-sm font-bold hover:bg-emerald-700 shadow-lg transition-all active:scale-[0.98] flex items-center gap-2">
                        <span>ğŸ“¥</span> ì—‘ì…€ ë‹¤ìš´ë¡œë“œ (ê¸€ìí¬ê¸° 9pt)
                    </button>
                </div>
                
                <!-- ì¢Œìš° ìŠ¤í¬ë¡¤ ì»¨í…Œì´ë„ˆ (ì ˆëŒ€ ì‚­ì œ ê¸ˆì§€) -->
                <div class="scroll-container border border-slate-200 rounded-lg shadow-inner max-h-[600px] bg-slate-50">
                    <table class="data-table w-full border-collapse table-fixed bg-white" id="mainTable">
                        <thead id="tableHeader">
                            <!-- JSì—ì„œ ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                        </thead>
                        <tbody id="resultBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="py-24 text-center border-2 border-dashed border-slate-200 rounded-xl bg-slate-50">
                <div class="text-5xl mb-4 opacity-30">ğŸ“‹</div>
                <p class="text-slate-500 text-base italic">í’ˆì…ˆ ë°ì´í„°ë¥¼ ë¨¼ì € ë¶ˆëŸ¬ì˜¨ í›„ ê³µë‚´ì—­ ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•´ ì£¼ì„¸ìš”.</p>
            </div>
        </div>
    </div>

    <script>
        let referenceData = [];
        const SPREADSHEET_ID = '1X1N_SUeP1TgEuh3phCzRrCDXml7pE5u50kQyTTBkASw';
        const SHEET_NAME = 'í’ˆì…ˆ';

        function showToast(message) {
            const toast = document.getElementById("toast");
            toast.innerText = message;
            toast.className = "show";
            setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
        }

        async function syncSheetData() {
            const status = document.getElementById('syncStatus');
            const btn = document.getElementById('syncBtn');
            try {
                btn.disabled = true;
                status.innerText = "â³ í´ë¼ìš°ë“œì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ê³  ìˆìŠµë‹ˆë‹¤...";
                const url = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(SHEET_NAME)}`;
                const response = await fetch(url);
                const csvText = await response.text();
                const rows = csvText.split('\n').map(row => {
                    return row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(cell => cell.replace(/^"|"$/g, '').trim());
                });
                referenceData = rows.slice(1).map(r => {
                    const extraData = [];
                    for(let i = 5; i <= 28; i++) { extraData.push(r[i] || ""); }
                    return {
                        fullText: `${r[0] || ''} ${r[1] || ''} ${r[2] || ''}`, 
                        name: r[0] || '',
                        spec: r[1] || '',
                        unit: r[2] || '',
                        matchName: r[4] || '', 
                        extraColumns: extraData 
                    };
                }).filter(item => item.name || item.spec);
                status.innerText = `âœ… ${referenceData.length}ê°œ í•­ëª© ë¡œë“œ ì™„ë£Œ`;
                btn.innerHTML = "âœ”ï¸ ë™ê¸°í™” ì™„ë£Œ";
                showToast("DB ë™ê¸°í™”ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                initTableHeader();
            } catch (error) {
                btn.disabled = false;
                status.innerText = "âŒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨";
                showToast("ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        }

        // ë„ˆë¹„ ì ˆë°˜ ì¶•ì†Œ ìœ ì§€
        function initTableHeader() {
            const header = document.getElementById('tableHeader');
            let html = `
                <colgroup>
                    <col style="width: 60px;"> <!-- í’ˆëª… -->
                    <col style="width: 55px;"> <!-- ê·œê²© -->
                    <col style="width: 25px;"> <!-- ë‹¨ìœ„ -->
                    <col style="width: 30px;"> <!-- ìˆ˜ëŸ‰ -->
                    <col style="width: 65px;"> <!-- í’ˆì…ˆì½”ë“œ -->
            `;
            let headerCells = `
                <tr>
                    <th class="bg-slate-200">í’ˆëª…</th>
                    <th class="bg-slate-200">ê·œê²©</th>
                    <th class="bg-slate-200">ë‹¨ìœ„</th>
                    <th class="bg-slate-200">ìˆ˜ëŸ‰</th>
                    <th class="bg-blue-100 text-blue-900">í’ˆì…ˆì½”ë“œ</th>
            `;
            for(let i=0; i < 24; i++) {
                const isPrice = (i % 2 !== 0);
                const colWidth = isPrice ? 35 : 45; 
                html += `<col style="width: ${colWidth}px;">`;
                headerCells += `<th class="${isPrice ? 'bg-indigo-50 text-indigo-800' : 'bg-slate-50'}">${isPrice ? 'í’ˆì…ˆ' : 'ë¹„ê³ '}</th>`;
            }
            html += `</colgroup>` + headerCells + `</tr>`;
            header.innerHTML = html;
        }

        function getSimilarity(s1, s2) {
            if (!s1 || !s2) return 0;
            s1 = s1.replace(/\s+/g, '').toLowerCase();
            s2 = s2.replace(/\s+/g, '').toLowerCase();
            if (s1 === s2) return 1.0;
            const b1 = new Set(); for (let i = 0; i < s1.length - 1; i++) b1.add(s1.substring(i, i + 2));
            const b2 = new Set(); for (let i = 0; i < s2.length - 1; i++) b2.add(s2.substring(i, i + 2));
            let intersect = 0; for (let b of b1) { if (b2.has(b)) intersect++; }
            return (2.0 * intersect) / (b1.size + b2.size);
        }

        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('loading').classList.replace('hidden', 'flex');
                document.getElementById('emptyState').classList.add('hidden');
                document.getElementById('resultArea').classList.add('hidden');
                setTimeout(() => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 });
                    processComparison(jsonData);
                }, 200);
            };
            reader.readAsArrayBuffer(file);
        });

        function processComparison(rows) {
            const resultBody = document.getElementById('resultBody');
            resultBody.innerHTML = '';
            let columnSums = new Array(24).fill(0);
            rows.forEach((row, idx) => {
                if (idx === 0 && (String(row[0]).includes('í’ˆëª…') || String(row[0]).includes('ëª…ì¹­'))) return;
                const exA = row[0] ? String(row[0]).trim() : "";
                const exB = row[1] ? String(row[1]).trim() : "";
                const exC = row[2] ? String(row[2]).trim() : "";
                const exD = parseFloat(row[3]) || 0;
                const isTotalRow = exA.includes('í•©ê³„') || exA.includes('ê³„');
                const hasContent = exA !== "" || exB !== "" || exC !== "";
                let matchedItem = null;
                let isMatched = false;
                if (hasContent && !isTotalRow) {
                    const exFull = `${exA} ${exB} ${exC}`;
                    let maxSim = 0;
                    referenceData.forEach(ref => {
                        const sim = getSimilarity(exFull, ref.fullText);
                        if (sim > maxSim) { maxSim = sim; matchedItem = ref; }
                    });
                    if (maxSim >= 0.8) isMatched = true;
                }
                const tr = document.createElement('tr');
                if (isTotalRow) tr.className = 'bg-blue-50 font-bold';
                else if (!hasContent) tr.className = 'h-5';
                else if (!isMatched) tr.className = 'text-slate-400 opacity-60';
                let rowHtml = `
                    <td class="text-left font-medium">${exA}</td>
                    <td class="text-left">${exB}</td>
                    <td>${exC}</td>
                    <td class="font-medium">${(hasContent && !isTotalRow) ? exD.toLocaleString() : ''}</td>
                    <td class="${isMatched ? 'text-blue-700 font-bold' : ''}">${isMatched ? matchedItem.matchName : (hasContent && !isTotalRow ? '-' : '')}</td>
                `;
                for (let i = 0; i < 24; i++) {
                    const isPriceCol = (i % 2 !== 0);
                    let displayValue = "";
                    if (isTotalRow) {
                        if (isPriceCol) {
                            displayValue = columnSums[i].toLocaleString(undefined, {minimumFractionDigits: 1, maximumFractionDigits: 1});
                            columnSums[i] = 0;
                        }
                    } else if (isMatched) {
                        const dbValue = matchedItem.extraColumns[i];
                        if (isPriceCol) {
                            const unitPrice = parseFloat(String(dbValue).replace(/,/g, '')) || 0;
                            const calcAmount = Math.round(unitPrice * exD * 10) / 10;
                            displayValue = calcAmount.toLocaleString(undefined, {minimumFractionDigits: 1, maximumFractionDigits: 1});
                            columnSums[i] += calcAmount;
                        } else { displayValue = dbValue; }
                    } else if (hasContent && !isTotalRow) { displayValue = isPriceCol ? "0.0" : "-"; }
                    const cellClass = isPriceCol ? 'text-right font-bold ' + (isTotalRow ? 'text-blue-800' : 'text-indigo-600') : 'text-left text-slate-500';
                    rowHtml += `<td class="${cellClass}">${displayValue}</td>`;
                }
                tr.innerHTML = rowHtml;
                resultBody.appendChild(tr);
            });
            document.getElementById('loading').classList.replace('flex', 'hidden');
            document.getElementById('resultArea').classList.remove('hidden');
            showToast("ëª¨ë“  ì‚°ì¶œ ì‘ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        }

        function exportToExcel() {
            try {
                const table = document.getElementById("mainTable");
                const ws = XLSX.utils.table_to_sheet(table);
                const range = XLSX.utils.decode_range(ws['!ref']);
                for (let R = range.s.r; R <= range.e.r; ++R) {
                    for (let C = range.s.c; C <= range.e.c; ++C) {
                        const cell_ref = XLSX.utils.encode_cell({ r: R, c: C });
                        if (!ws[cell_ref]) continue;
                        if (!ws[cell_ref].s) ws[cell_ref].s = {};
                        ws[cell_ref].s.font = {
                            name: 'Pretendard',
                            sz: 9, 
                            bold: R === 0 || (ws[cell_ref].v && String(ws[cell_ref].v).includes('í•©ê³„'))
                        };
                        ws[cell_ref].s.border = {
                            top: { style: "thin", color: { rgb: "E2E8F0" } },
                            bottom: { style: "thin", color: { rgb: "E2E8F0" } },
                            left: { style: "thin", color: { rgb: "E2E8F0" } },
                            right: { style: "thin", color: { rgb: "E2E8F0" } }
                        };
                        if (R === 0) {
                            ws[cell_ref].s.fill = { fgColor: { rgb: "F1F5F9" } };
                            ws[cell_ref].s.alignment = { horizontal: "center", vertical: "center" };
                        }
                    }
                }
                const wscols = [
                    { wch: 10 }, { wch: 8 }, { wch: 4 }, { wch: 5 }, { wch: 12 },
                ];
                for (let i = 0; i < 24; i++) {
                    wscols.push({ wch: (i % 2 !== 0) ? 7 : 8 });
                }
                ws['!cols'] = wscols;
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "ì‚°ì¶œê²°ê³¼");
                XLSX.writeFile(wb, "í’ˆì…ˆ_ìë™ì‚°ì¶œ_ë‚´ì—­ì„œ_9pt.xlsx");
                showToast("ì—‘ì…€ íŒŒì¼ ìƒì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            } catch (err) {
                console.error(err);
                showToast("ì—‘ì…€ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        }
    </script>
</body>
</html>
