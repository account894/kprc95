<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ—ï¸ í’ˆì…ˆë‹¨ê°€ ì§€ëŠ¥í˜• ê³„ì‚°ê¸° (ì´ˆì •ë°€í˜•)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ì—‘ì…€ íŒŒì¼ ì²˜ë¦¬ ë° ìŠ¤íƒ€ì¼ ì ìš©ì„ ìœ„í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ (ìŠ¤íƒ€ì¼ ì§€ì› ë²„ì „) -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap');
        body { font-family: 'Pretendard', sans-serif; }
        
        /* ì „ì²´ í…Œì´ë¸” í…ìŠ¤íŠ¸ í¬ê¸° 9px í†µì¼ */
        .data-table th { 
            @apply bg-slate-100 text-slate-700 font-bold p-1 border border-slate-300 sticky top-0 whitespace-nowrap; 
            font-size: 9px;
        }
        
        .data-table td { 
            @apply p-1 border border-slate-200 text-center whitespace-nowrap overflow-hidden text-ellipsis; 
            font-size: 9px;
            min-height: 22px;
        }
        
        /* ê°€ë¡œ ìŠ¤í¬ë¡¤ë°” ê°•ì œ ìœ ì§€ ë° ë””ìì¸ */
        .scroll-container {
            display: block;
            width: 100%;
            overflow-x: auto; /* ì¢Œìš° ìŠ¤í¬ë¡¤ í™œì„±í™” */
            -webkit-overflow-scrolling: touch;
        }

        .scroll-container::-webkit-scrollbar { height: 8px; display: block !important; }
        .scroll-container::-webkit-scrollbar-track { background: #f8fafc; }
        .scroll-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; border: 2px solid #f8fafc; }
        .scroll-container::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .loading-spinner { border-top-color: #3b82f6; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #toast {
            visibility: hidden;
            min-width: 200px;
            margin-left: -100px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 4px;
            padding: 8px;
            position: fixed;
            z-index: 100;
            left: 50%;
            bottom: 20px;
            font-size: 10px;
        }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 20px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 20px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    </style>
</head>
<body class="bg-slate-50 min-h-screen p-2">

    <div id="toast">ë©”ì‹œì§€ ë‚´ìš©</div>

    <div class="max-w-full mx-auto bg-white rounded-lg shadow-lg overflow-hidden border border-slate-200">
        <!-- Header -->
        <div class="bg-slate-800 p-3 text-white">
            <h1 class="text-base font-bold flex items-center gap-2">
                <span>ğŸ—ï¸</span> í’ˆì…ˆë‹¨ê°€ ì§€ëŠ¥í˜• ìë™ ì‚°ì¶œ ì‹œìŠ¤í…œ
            </h1>
            <p class="text-slate-400" style="font-size: 9px;">
                9px í…ìŠ¤íŠ¸ ë° ì´ˆì •ë°€ ë„ˆë¹„ ì ìš©. ì¢Œìš° ìŠ¤í¬ë¡¤ì„ í†µí•´ ACì—´ê¹Œì§€ í™•ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤.
            </p>
        </div>

        <div class="p-3">
            <!-- Configuration & Upload -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                <div class="bg-blue-50 p-2 rounded border border-blue-100">
                    <button id="syncBtn" onclick="syncSheetData()" class="w-full bg-white border border-blue-600 text-blue-600 hover:bg-blue-50 py-1 rounded text-[10px] font-bold shadow-sm flex items-center justify-center gap-1">
                        ğŸ”„ í’ˆì…ˆ DB ë™ê¸°í™”
                    </button>
                    <p id="syncStatus" class="mt-1 text-[8px] text-slate-500 text-center">ë°ì´í„° ë¡œë“œ ì „</p>
                </div>

                <div class="bg-emerald-50 p-2 rounded border border-emerald-100">
                    <input type="file" id="fileInput" accept=".xlsx, .xls" 
                        class="block w-full text-[9px] text-slate-500 file:mr-2 file:py-1 file:px-2 file:rounded file:border-0 file:text-[9px] file:font-bold file:bg-emerald-100 file:text-emerald-700 hover:file:bg-emerald-200 cursor-pointer"
                    />
                </div>
            </div>

            <!-- Loading -->
            <div id="loading" class="hidden flex-col items-center justify-center py-6">
                <div class="loading-spinner w-5 h-5 border-2 border-slate-200 rounded-full mb-2"></div>
                <p class="text-slate-500 text-[10px]">ë°ì´í„° ë§¤ì¹­ ì¤‘...</p>
            </div>

            <!-- Result Table Area -->
            <div id="resultArea" class="hidden">
                <div class="flex items-center justify-between mb-2">
                    <h2 class="text-[10px] font-bold text-slate-800">ì‚°ì¶œ ë‚´ì—­ ê²°ê³¼ (ì¢Œìš° ìŠ¤í¬ë¡¤ ê°€ëŠ¥)</h2>
                    <button onclick="exportToExcel()" class="bg-emerald-600 text-white px-3 py-1 rounded text-[9px] font-bold hover:bg-emerald-700 transition-colors">
                        ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ (ê¸€ìí¬ê¸° 9pt)
                    </button>
                </div>
                
                <!-- ì¢Œìš° ìŠ¤í¬ë¡¤ ì»¨í…Œì´ë„ˆ (ì ˆëŒ€ ì‚­ì œ ê¸ˆì§€) -->
                <div class="scroll-container border border-slate-200 rounded shadow-inner max-h-[600px]">
                    <table class="data-table w-full border-collapse table-fixed" id="mainTable">
                        <thead id="tableHeader">
                            <!-- JSì—ì„œ ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                        </thead>
                        <tbody id="resultBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="py-12 text-center border border-dashed border-slate-200 rounded-lg bg-slate-50">
                <p class="text-slate-400 text-[10px] italic">í’ˆì…ˆ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¨ í›„ ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.</p>
            </div>
        </div>
    </div>

    <script>
        let referenceData = [];
        const SPREADSHEET_ID = '1X1N_SUeP1TgEuh3phCzRrCDXml7pE5u50kQyTTBkASw';
        const SHEET_NAME = 'í’ˆì…ˆ';

        function showToast(message) {
            const toast = document.getElementById("toast");
            toast.innerText = message;
            toast.className = "show";
            setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
        }

        async function syncSheetData() {
            const status = document.getElementById('syncStatus');
            const btn = document.getElementById('syncBtn');
            try {
                btn.disabled = true;
                status.innerText = "â³ ë°ì´í„° ë¡œë”©...";
                const url = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(SHEET_NAME)}`;
                const response = await fetch(url);
                const csvText = await response.text();
                const rows = csvText.split('\n').map(row => {
                    return row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(cell => cell.replace(/^"|"$/g, '').trim());
                });
                referenceData = rows.slice(1).map(r => {
                    const extraData = [];
                    for(let i = 5; i <= 28; i++) { extraData.push(r[i] || ""); }
                    return {
                        fullText: `${r[0] || ''} ${r[1] || ''} ${r[2] || ''}`, 
                        name: r[0] || '',
                        spec: r[1] || '',
                        unit: r[2] || '',
                        matchName: r[4] || '', 
                        extraColumns: extraData 
                    };
                }).filter(item => item.name || item.spec);
                status.innerText = `âœ… ${referenceData.length}ê°œ ë¡œë“œ ì™„ë£Œ`;
                btn.innerHTML = "âœ”ï¸ ë™ê¸°í™” ì™„ë£Œ";
                showToast("DB ë™ê¸°í™” ì™„ë£Œ");
                initTableHeader();
            } catch (error) {
                btn.disabled = false;
                showToast("ë¡œë“œ ì‹¤íŒ¨");
            }
        }

        // ë„ˆë¹„ ì ˆë°˜ ì¶•ì†Œ (í’ˆëª… 50, ê·œê²© 45, ë‹¨ìœ„ 17, ìˆ˜ëŸ‰ 22, ì½”ë“œ 55, í’ˆì…ˆ 27, ë¹„ê³  35)
        function initTableHeader() {
            const header = document.getElementById('tableHeader');
            let html = `
                <colgroup>
                    <col style="width: 60px;"> <!-- í’ˆëª… -->
                    <col style="width: 55px;"> <!-- ê·œê²© -->
                    <col style="width: 25px;"> <!-- ë‹¨ìœ„ -->
                    <col style="width: 30px;"> <!-- ìˆ˜ëŸ‰ -->
                    <col style="width: 65px;"> <!-- í’ˆì…ˆì½”ë“œ -->
            `;
            let headerCells = `
                <tr>
                    <th class="bg-slate-200">í’ˆëª…</th>
                    <th class="bg-slate-200">ê·œê²©</th>
                    <th class="bg-slate-200">ë‹¨ìœ„</th>
                    <th class="bg-slate-200">ìˆ˜ëŸ‰</th>
                    <th class="bg-blue-100 text-blue-900">í’ˆì…ˆì½”ë“œ</th>
            `;
            for(let i=0; i < 24; i++) {
                const isPrice = (i % 2 !== 0);
                const colWidth = isPrice ? 35 : 45; 
                html += `<col style="width: ${colWidth}px;">`;
                headerCells += `<th class="${isPrice ? 'bg-indigo-50 text-indigo-800' : 'bg-slate-50'}">${isPrice ? 'í’ˆì…ˆ' : 'ë¹„ê³ '}</th>`;
            }
            html += `</colgroup>` + headerCells + `</tr>`;
            header.innerHTML = html;
        }

        function getSimilarity(s1, s2) {
            if (!s1 || !s2) return 0;
            s1 = s1.replace(/\s+/g, '').toLowerCase();
            s2 = s2.replace(/\s+/g, '').toLowerCase();
            if (s1 === s2) return 1.0;
            const b1 = new Set(); for (let i = 0; i < s1.length - 1; i++) b1.add(s1.substring(i, i + 2));
            const b2 = new Set(); for (let i = 0; i < s2.length - 1; i++) b2.add(s2.substring(i, i + 2));
            let intersect = 0; for (let b of b1) { if (b2.has(b)) intersect++; }
            return (2.0 * intersect) / (b1.size + b2.size);
        }

        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('loading').classList.replace('hidden', 'flex');
                document.getElementById('emptyState').classList.add('hidden');
                document.getElementById('resultArea').classList.add('hidden');
                setTimeout(() => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 });
                    processComparison(jsonData);
                }, 200);
            };
            reader.readAsArrayBuffer(file);
        });

        function processComparison(rows) {
            const resultBody = document.getElementById('resultBody');
            resultBody.innerHTML = '';
            let columnSums = new Array(24).fill(0);
            rows.forEach((row, idx) => {
                if (idx === 0 && (String(row[0]).includes('í’ˆëª…') || String(row[0]).includes('ëª…ì¹­'))) return;
                const exA = row[0] ? String(row[0]).trim() : "";
                const exB = row[1] ? String(row[1]).trim() : "";
                const exC = row[2] ? String(row[2]).trim() : "";
                const exD = parseFloat(row[3]) || 0;
                const isTotalRow = exA.includes('í•©ê³„') || exA.includes('ê³„');
                const hasContent = exA !== "" || exB !== "" || exC !== "";
                let matchedItem = null;
                let isMatched = false;
                if (hasContent && !isTotalRow) {
                    const exFull = `${exA} ${exB} ${exC}`;
                    let maxSim = 0;
                    referenceData.forEach(ref => {
                        const sim = getSimilarity(exFull, ref.fullText);
                        if (sim > maxSim) { maxSim = sim; matchedItem = ref; }
                    });
                    if (maxSim >= 0.8) isMatched = true;
                }
                const tr = document.createElement('tr');
                if (isTotalRow) tr.className = 'bg-blue-50 font-bold';
                else if (!hasContent) tr.className = 'h-5';
                else if (!isMatched) tr.className = 'text-slate-400 opacity-60';
                let rowHtml = `
                    <td class="text-left font-medium">${exA}</td>
                    <td class="text-left">${exB}</td>
                    <td>${exC}</td>
                    <td class="font-medium">${(hasContent && !isTotalRow) ? exD.toLocaleString() : ''}</td>
                    <td class="${isMatched ? 'text-blue-700 font-bold' : ''}">${isMatched ? matchedItem.matchName : (hasContent && !isTotalRow ? '-' : '')}</td>
                `;
                for (let i = 0; i < 24; i++) {
                    const isPriceCol = (i % 2 !== 0);
                    let displayValue = "";
                    if (isTotalRow) {
                        if (isPriceCol) {
                            displayValue = columnSums[i].toLocaleString(undefined, {minimumFractionDigits: 1, maximumFractionDigits: 1});
                            columnSums[i] = 0;
                        }
                    } else if (isMatched) {
                        const dbValue = matchedItem.extraColumns[i];
                        if (isPriceCol) {
                            const unitPrice = parseFloat(String(dbValue).replace(/,/g, '')) || 0;
                            const calcAmount = Math.round(unitPrice * exD * 10) / 10;
                            displayValue = calcAmount.toLocaleString(undefined, {minimumFractionDigits: 1, maximumFractionDigits: 1});
                            columnSums[i] += calcAmount;
                        } else { displayValue = dbValue; }
                    } else if (hasContent && !isTotalRow) { displayValue = isPriceCol ? "0.0" : "-"; }
                    const cellClass = isPriceCol ? 'text-right font-bold ' + (isTotalRow ? 'text-blue-800' : 'text-indigo-600') : 'text-left text-slate-500';
                    rowHtml += `<td class="${cellClass}">${displayValue}</td>`;
                }
                tr.innerHTML = rowHtml;
                resultBody.appendChild(tr);
            });
            document.getElementById('loading').classList.replace('flex', 'hidden');
            document.getElementById('resultArea').classList.remove('hidden');
            showToast("ì‚°ì¶œ ì™„ë£Œ");
        }

        // ì—‘ì…€ ë‚´ë³´ë‚´ê¸° (ê¸€ì í¬ê¸° 9pt ì ìš© ë²„ì „)
        function exportToExcel() {
            try {
                const table = document.getElementById("mainTable");
                // í…Œì´ë¸”ë¡œë¶€í„° ì‹œíŠ¸ ìƒì„±
                const ws = XLSX.utils.table_to_sheet(table);

                // ëª¨ë“  ì…€ì— í°íŠ¸ ì‚¬ì´ì¦ˆ 9pt ì ìš©
                const range = XLSX.utils.decode_range(ws['!ref']);
                for (let R = range.s.r; R <= range.e.r; ++R) {
                    for (let C = range.s.c; C <= range.e.c; ++C) {
                        const cell_ref = XLSX.utils.encode_cell({ r: R, c: C });
                        if (!ws[cell_ref]) continue;
                        
                        // ìŠ¤íƒ€ì¼ ê°ì²´ ì´ˆê¸°í™”
                        if (!ws[cell_ref].s) ws[cell_ref].s = {};
                        
                        // í°íŠ¸ ì„¤ì •
                        ws[cell_ref].s.font = {
                            name: 'Pretendard',
                            sz: 9, // ê¸€ì í¬ê¸° 9pt
                            bold: R === 0 || (ws[cell_ref].v && String(ws[cell_ref].v).includes('í•©ê³„')) // í—¤ë” ë° í•©ê³„í–‰ ë³¼ë“œ
                        };

                        // í…Œë‘ë¦¬ ì„¤ì •
                        ws[cell_ref].s.border = {
                            top: { style: "thin", color: { rgb: "E2E8F0" } },
                            bottom: { style: "thin", color: { rgb: "E2E8F0" } },
                            left: { style: "thin", color: { rgb: "E2E8F0" } },
                            right: { style: "thin", color: { rgb: "E2E8F0" } }
                        };

                        // ë°°ê²½ìƒ‰ ë° ì •ë ¬
                        if (R === 0) {
                            ws[cell_ref].s.fill = { fgColor: { rgb: "F1F5F9" } };
                            ws[cell_ref].s.alignment = { horizontal: "center", vertical: "center" };
                        }
                    }
                }

                // ì—‘ì…€ ì—´ ë„ˆë¹„ ì„¤ì • (wch ë‹¨ìœ„ ê¸°ì¤€ ì¶•ì†Œ)
                const wscols = [
                    { wch: 10 }, // í’ˆëª…
                    { wch: 8 },  // ê·œê²©
                    { wch: 4 },  // ë‹¨ìœ„
                    { wch: 5 },  // ìˆ˜ëŸ‰
                    { wch: 12 }, // í’ˆì…ˆì½”ë“œ
                ];
                for (let i = 0; i < 24; i++) {
                    wscols.push({ wch: (i % 2 !== 0) ? 7 : 8 }); // í’ˆì…ˆ 7, ë¹„ê³  8
                }
                ws['!cols'] = wscols;

                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "ì‚°ì¶œê²°ê³¼");
                
                // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
                XLSX.writeFile(wb, "í’ˆì…ˆ_ìë™ì‚°ì¶œ_ë‚´ì—­ì„œ_9pt.xlsx");
                showToast("ì—‘ì…€(9pt) ë‹¤ìš´ë¡œë“œ ì‹œì‘");
            } catch (err) {
                console.error(err);
                showToast("ì—‘ì…€ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
            }
        }
    </script>
</body>
</html>
