<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìì¬/ë…¸ì„ ë‹¨ê°€ ì¶”ì´ í˜„í™© (ì •ë³´ë§ˆë‹¹)</title>
    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™” */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: 'Noto Sans KR', sans-serif; 
            background-color: #f0f2f5; 
            color: #333;
            height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center; 
            padding-top: 30px;     
            padding-bottom: 30px;  
        }

        /* ë©”ì¸ ì»¨í…Œì´ë„ˆ: ê°œë°©ê°ì„ ìœ„í•´ ë„ˆë¹„ ì¶•ì†Œ ë° ë‚´ë¶€ ì—¬ë°± í™•ëŒ€ */
        .dashboard-container {
            width: 75%;              /* 85% -> 75% ì–‘ì˜† ì—¬ë°± ëŒ€í­ í™•ë³´ */
            max-width: 1200px;       /* ìµœëŒ€ ë„ˆë¹„ ì œí•œìœ¼ë¡œ ì‹œì„  ì§‘ì¤‘ */
            height: 100%;            
            background-color: #fff;  
            border-radius: 20px;     /* ëª¨ì„œë¦¬ë¥¼ ë” ë‘¥ê¸€ê²Œ */
            box-shadow: 0 10px 30px rgba(0,0,0,0.08); /* ê·¸ë¦¼ì ê°•í™” */
            display: flex;
            flex-direction: column;
            overflow: hidden;        
            padding: 0 0 20px 0;     /* í•˜ë‹¨ íŒ¨ë”© */
        }

        /* ìƒë‹¨ ì˜ì—­ (ë‚´ë¶€ íŒ¨ë”© ë„‰ë„‰í•˜ê²Œ) */
        .top-section {
            padding: 30px 40px 0 40px; /* ë‚´ë¶€ ì—¬ë°± í™•ëŒ€ */
            flex-shrink: 0; 
        }

        /* í—¤ë” ìŠ¤íƒ€ì¼ */
        .header-area {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .header-title {
            font-size: 24px;
            font-weight: 800; /* í°íŠ¸ ë” êµµê²Œ */
            color: #111;
            display: flex;
            align-items: center;
            gap: 10px;
            letter-spacing: -0.5px;
        }
        .update-badge {
            font-size: 13px;
            background: #f1f3f5;
            padding: 6px 10px;
            border-radius: 6px;
            color: #495057;
            font-weight: 500;
        }

        /* ì»¨íŠ¸ë¡¤ ì˜ì—­ */
        .header-controls {
            display: flex;
            gap: 12px;
        }
        .sheet-select {
            padding: 10px 14px;
            border: 1px solid #dfe1e5;
            border-radius: 8px;
            font-size: 14px;
            background-color: white;
            cursor: pointer;
            min-width: 160px;
            outline: none;
            transition: border-color 0.2s;
        }
        .sheet-select:hover { border-color: #4f46e5; }
        
        .sync-btn {
            padding: 10px 20px; 
            background: #4f46e5; 
            color: white; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s, transform 0.1s;
        }
        .sync-btn:hover { background: #4338ca; transform: translateY(-1px); }
        .sync-btn:active { transform: translateY(0); }

        /* --- Top 3 ë­í‚¹ ì„¹ì…˜ --- */
        .ranking-section {
            display: grid;
            grid-template-columns: 1fr 1fr; 
            gap: 25px; /* ê°„ê²© í™•ëŒ€ */
            margin-bottom: 30px;
        }
        .rank-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #edf2f7;
        }
        .rank-title {
            font-size: 15px;
            font-weight: 700;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .rank-title.up { color: #e11d48; } 
        .rank-title.down { color: #2563eb; }

        .rank-list {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .rank-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            background: #fff;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.03);
            transition: transform 0.2s;
        }
        .rank-item:hover { transform: translateX(2px); }
        
        .rank-item-name { font-weight: 500; color: #333; max-width: 55%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .rank-item-spec { font-size: 12px; color: #888; max-width: 20%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .rank-item-val { font-weight: 700; font-feature-settings: "tnum"; white-space: nowrap; }
        .rank-empty { font-size: 14px; color: #999; text-align: center; padding: 10px 0; }

        /* í…Œì´ë¸” ì˜ì—­ ì»¨í…Œì´ë„ˆ (ì—¬ë°± í™•ë³´ìš©) */
        .table-area-wrapper {
            padding: 0 40px; /* í—¤ë”ì™€ ë¦¬ìŠ¤íŠ¸ ì¢Œìš° ì—¬ë°± */
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* í…Œì´ë¸” í—¤ë” (ê³ ì •) */
        .table-header {
            display: grid;
            /* A1(2), A2(3), A3(1), A4(1.5) ë¹„ìœ¨ */
            grid-template-columns: 2fr 3fr 1fr 1.5fr; 
            background-color: #eaecf0;
            font-weight: 700;
            color: #4b5563;
            padding: 14px 0; /* ìƒí•˜ íŒ¨ë”© í™•ëŒ€ */
            text-align: center;
            border-top: 1px solid #d1d5db;
            border-bottom: 1px solid #d1d5db;
            border-radius: 8px 8px 0 0;
            
            /* [ì¤‘ìš”] ìŠ¤í¬ë¡¤ë°” ë„ˆë¹„(8px)ë§Œí¼ ìš°ì¸¡ íŒ¨ë”©ì„ ì£¼ì–´ ë°ì´í„° ì—´ê³¼ ì •ë ¬ì„ ë§ì¶¤ */
            padding-right: 8px; 
        }
        .th-cell { padding: 0 20px; } /* ì…€ ë‚´ë¶€ ì—¬ë°± í™•ëŒ€ */

        /* ê°€ìƒ ìŠ¤í¬ë¡¤ ë·°í¬íŠ¸ */
        .virtual-scroll-viewport {
            flex: 1; 
            overflow-y: auto;
            position: relative;
            background: white;
            border-left: 1px solid #eee; /* ì‹œê°ì  ê²½ê³„ */
            border-right: 1px solid #eee;
        }

        /* ìŠ¤í¬ë¡¤ë°” ì»¤ìŠ¤í…€ */
        .virtual-scroll-viewport::-webkit-scrollbar { width: 8px; }
        .virtual-scroll-viewport::-webkit-scrollbar-track { background: #fafafa; }
        .virtual-scroll-viewport::-webkit-scrollbar-thumb { background: #ced4da; border-radius: 4px; }
        .virtual-scroll-viewport::-webkit-scrollbar-thumb:hover { background: #adb5bd; }

        /* ë°ì´í„° í–‰ ìŠ¤íƒ€ì¼ */
        .table-row {
            display: grid;
            grid-template-columns: 2fr 3fr 1fr 1.5fr;
            border-bottom: 1px solid #f1f3f5;
            align-items: center;
            position: absolute;
            width: 100%;
            left: 0;
            transition: background-color 0.1s;
        }
        .table-row:hover { background-color: #f8f9fa; }

        .td-cell {
            padding: 0 20px; /* í—¤ë”ì™€ ë™ì¼í•œ íŒ¨ë”© ì ìš© */
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: default;
            color: #495057;
        }

        .text-left { text-align: left; }
        .text-center { text-align: center; }
        .text-right { text-align: right; font-feature-settings: "tnum"; font-variant-numeric: tabular-nums; }

        .price-up { color: #e11d48; font-weight: 600; }
        .price-down { color: #2563eb; font-weight: 600; }
        .price-flat { color: #adb5bd; }

        .status-message {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 16px;
            color: #868e96;
            text-align: center;
        }

        /* íˆ´íŒ */
        .td-cell:hover::after {
            content: attr(title);
            position: fixed;
            background: rgba(33, 37, 41, 0.95);
            color: #fff;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            z-index: 1000;
            white-space: normal;
            max-width: 350px;
            pointer-events: none;
            display: none; 
            line-height: 1.4;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>

<div class="dashboard-container">
    
    <!-- ìƒë‹¨ ê³ ì • ì˜ì—­ -->
    <div class="top-section">
        <div class="header-area">
            <div class="header-left">
                <div class="header-title">
                    <span>ğŸ“ˆ ìì¬/ë…¸ì„ ë‹¨ê°€ í˜„í™©</span>
                </div>
                <span class="update-badge" id="dataCountBadge">ë°ì´í„° ë¡œë”© ì¤‘...</span>
            </div>
            
            <div class="header-controls">
                <select id="sheetSelect" class="sheet-select" onchange="fetchGoogleSheetData()">
                    <option value="íŒŒì´í”„">íŒŒì´í”„ë¥˜</option>
                    <option value="ì „ì„ ê´€">ì „ì„ ê´€ë¥˜ (ê¸°ë³¸)</option>
                    <option value="ì •ë¶€ë…¸ì„">ì •ë¶€ë…¸ì„</option>
                </select>
                <button onclick="fetchGoogleSheetData()" class="sync-btn">ğŸ”„ ë™ê¸°í™”</button>
            </div>
        </div>

        <!-- Top 3 ë­í‚¹ ì„¹ì…˜ -->
        <div class="ranking-section">
            <div class="rank-card">
                <div class="rank-title up">ğŸ”¥ ê°€ê²© ê¸‰ë“± Top 3</div>
                <ul class="rank-list" id="rankListUp">
                    <li class="rank-empty">ë°ì´í„° ë¶„ì„ ì¤‘...</li>
                </ul>
            </div>
            <div class="rank-card">
                <div class="rank-title down">ğŸ’§ ê°€ê²© ê¸‰ë½ Top 3</div>
                <ul class="rank-list" id="rankListDown">
                    <li class="rank-empty">ë°ì´í„° ë¶„ì„ ì¤‘...</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- í…Œì´ë¸” ì˜ì—­ (í—¤ë” + ë¦¬ìŠ¤íŠ¸) -->
    <div class="table-area-wrapper">
        <!-- í…Œì´ë¸” í—¤ë” -->
        <div class="table-header">
            <div class="th-cell text-left" id="th-col1">í’ˆëª…</div>
            <div class="th-cell text-left" id="th-col2">ê·œê²©</div>
            <div class="th-cell text-center" id="th-col3">ë‹¨ìœ„</div>
            <div class="th-cell text-right" id="th-col4">ë“±ë½</div>
        </div>

        <!-- ê°€ìƒ ìŠ¤í¬ë¡¤ ë·°í¬íŠ¸ -->
        <div class="virtual-scroll-viewport" id="viewport">
            <div id="contentContainer" style="position: relative; height: 0;"></div>
            <div id="statusMsg" class="status-message">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
        </div>
    </div>

</div>

<script>
    // --- ì„¤ì •ê°’ ---
    const SHEET_ID = '1D7hfHKGWzrN3MNItBKkWlKJxFw64gD5mXK3URmfckbI';
    const ROW_HEIGHT = 50; // í–‰ ë†’ì´ ì‚´ì§ ì¦ê°€ (45 -> 50) ê°€ë…ì„± í–¥ìƒ

    // ìƒíƒœ ë³€ìˆ˜
    let allData = [];
    const viewport = document.getElementById('viewport');
    const contentContainer = document.getElementById('contentContainer');
    const statusMsg = document.getElementById('statusMsg');
    const sheetSelect = document.getElementById('sheetSelect');
    
    // Top 3 ì—˜ë¦¬ë¨¼íŠ¸
    const rankListUp = document.getElementById('rankListUp');
    const rankListDown = document.getElementById('rankListDown');

    // 1. êµ¬ê¸€ ì‹œíŠ¸ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    async function fetchGoogleSheetData() {
        const selectedSheet = sheetSelect.value;
        statusMsg.innerText = `"${selectedSheet}" ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...`;
        statusMsg.style.display = 'block';
        contentContainer.innerHTML = '';
        
        rankListUp.innerHTML = '<li class="rank-empty">ë¡œë”© ì¤‘...</li>';
        rankListDown.innerHTML = '<li class="rank-empty">ë¡œë”© ì¤‘...</li>';
        
        document.getElementById('dataCountBadge').innerText = 'ë¡œë”© ì¤‘...';

        const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(selectedSheet)}`;

        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error("ë„¤íŠ¸ì›Œí¬ ì‘ë‹µ ì‹¤íŒ¨");
            
            const text = await response.text();
            parseCSV(text);
        } catch (error) {
            console.error(error);
            statusMsg.innerHTML = `<span style="color:red">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨.<br>ì‹œíŠ¸ëª… í™•ì¸ í•„ìš”</span>`;
            document.getElementById('dataCountBadge').innerText = 'ì˜¤ë¥˜ ë°œìƒ';
        }
    }

    // 2. CSV íŒŒì‹±
    function parseCSV(csvText) {
        const rows = csvText.split('\n');
        const parsedRows = rows.map(row => {
            const regex = /(?:^|,)("(?:[^"]|"")*"|[^,]*)/g;
            let columns = [];
            let match;
            while (match = regex.exec(row)) {
                let val = match[1];
                if (val.length > 0 && val[0] === '"') val = val.slice(1, -1).replace(/""/g, '"');
                columns.push(val.trim());
            }
            return columns;
        });

        // í—¤ë” ì—…ë°ì´íŠ¸ (1í–‰)
        if (parsedRows.length > 0) {
            const headers = parsedRows[0];
            if (headers.length >= 1) document.getElementById('th-col1').innerText = headers[0] || 'í•­ëª©1';
            if (headers.length >= 2) document.getElementById('th-col2').innerText = headers[1] || 'í•­ëª©2';
            if (headers.length >= 3) document.getElementById('th-col3').innerText = headers[2] || 'í•­ëª©3';
            if (headers.length >= 4) document.getElementById('th-col4').innerText = headers[3] || 'ê°’';
        }

        // ë°ì´í„° (2í–‰ë¶€í„°)
        allData = parsedRows.slice(1).filter(cols => cols.length >= 1);

        if (allData.length === 0) {
            statusMsg.innerText = "í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.";
            document.getElementById('dataCountBadge').innerText = '0ê±´';
            return;
        }

        statusMsg.style.display = 'none';
        document.getElementById('dataCountBadge').innerText = `ì´ ${allData.length.toLocaleString()}ê±´`;
        
        updateRankings();
        initVirtualScroll();
    }

    // Top 3 ë­í‚¹ ê³„ì‚°
    function updateRankings() {
        const validItems = allData.map(row => {
            const rawVal = row[3] || '0';
            const val = parseFloat(rawVal.replace(/,/g, ''));
            return {
                name: row[0] || '-',
                spec: row[1] || '',
                rawVal: rawVal,
                val: isNaN(val) ? 0 : val
            };
        });

        const rising = validItems.filter(item => item.val > 0)
                                 .sort((a, b) => b.val - a.val)
                                 .slice(0, 3);

        const falling = validItems.filter(item => item.val < 0)
                                  .sort((a, b) => a.val - b.val)
                                  .slice(0, 3);

        renderRankList(rankListUp, rising, 'up');
        renderRankList(rankListDown, falling, 'down');
    }

    function renderRankList(container, items, type) {
        if (items.length === 0) {
            container.innerHTML = `<li class="rank-empty">í•´ë‹¹ ë‚´ì—­ ì—†ìŒ</li>`;
            return;
        }

        const html = items.map((item) => {
            const icon = type === 'up' ? 'â–²' : 'â–¼';
            const colorClass = type === 'up' ? 'price-up' : 'price-down';
            let displayVal = item.rawVal;
            if(type === 'up' && !displayVal.includes('+')) displayVal = '+' + displayVal;
            
            return `
                <li class="rank-item">
                    <div style="display:flex; align-items:center; overflow:hidden; flex:1; gap:6px;">
                        <span class="rank-item-name" title="${item.name}">${item.name}</span>
                        <span class="rank-item-spec" title="${item.spec}">${item.spec}</span>
                    </div>
                    <span class="rank-item-val ${colorClass}">
                        <span style="font-size:10px; margin-right:2px;">${icon}</span>${displayVal}
                    </span>
                </li>
            `;
        }).join('');
        
        container.innerHTML = html;
    }

    // ê°€ìƒ ìŠ¤í¬ë¡¤ ì´ˆê¸°í™”
    function initVirtualScroll() {
        contentContainer.style.height = `${allData.length * ROW_HEIGHT}px`;
        viewport.removeEventListener('scroll', onScroll); 
        viewport.addEventListener('scroll', onScroll);
        onScroll();
    }

    function onScroll() {
        const scrollTop = viewport.scrollTop;
        const viewportHeight = viewport.clientHeight;
        const startIndex = Math.floor(scrollTop / ROW_HEIGHT);
        const endIndex = Math.min(allData.length, Math.ceil((scrollTop + viewportHeight) / ROW_HEIGHT));
        const renderStart = Math.max(0, startIndex - 5);
        const renderEnd = Math.min(allData.length, endIndex + 5);
        renderRows(renderStart, renderEnd);
    }

    function renderRows(start, end) {
        let html = '';
        for (let i = start; i < end; i++) {
            const rowData = allData[i];
            const col1 = rowData[0] || '';
            const col2 = rowData[1] || '';
            const col3 = rowData[2] || '';
            const col4Raw = rowData[3] || '0'; 

            let diffVal = parseFloat(col4Raw.replace(/,/g, ''));
            let diffClass = 'price-flat';
            let diffIcon = '';
            let diffText = col4Raw; 

            if (!isNaN(diffVal)) {
                diffText = diffVal.toLocaleString();
                if (diffVal > 0) {
                    diffClass = 'price-up';
                    diffIcon = 'â–²';
                    diffText = `+${diffText}`;
                } else if (diffVal < 0) {
                    diffClass = 'price-down';
                    diffIcon = 'â–¼';
                }
            } else {
                diffClass = ''; 
                diffText = col4Raw;
            }

            const topPos = i * ROW_HEIGHT;
            html += `
                <div class="table-row" style="height: ${ROW_HEIGHT}px; top: ${topPos}px;">
                    <div class="td-cell text-left" title="${col1}">${col1}</div>
                    <div class="td-cell text-left" title="${col2}">${col2}</div>
                    <div class="td-cell text-center">${col3}</div>
                    <div class="td-cell text-right ${diffClass}">
                        <span style="margin-right:4px;">${diffIcon}</span>${diffText}
                    </div>
                </div>
            `;
        }
        contentContainer.innerHTML = html;
    }

    window.onload = fetchGoogleSheetData;

</script>

</body>
</html>
